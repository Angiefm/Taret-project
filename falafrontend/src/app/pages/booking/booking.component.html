<div class="booking-container">
  <div class="booking-header">
    <h1 class="booking-title">
      <mat-icon>hotel</mat-icon>
      Realizar Reserva
    </h1>
    <p class="booking-subtitle">
      Complete el formulario para reservar su estadía en {{ selectedHotel()?.name || 'nuestro hotel' }}
    </p>
  </div>

  <div class="booking-content">
    <mat-horizontal-stepper [linear]="true" #stepper class="booking-stepper">
      
      <!-- Paso 1: Información del Huésped -->
      <mat-step [stepControl]="guestForm" label="Información del Huésped">
        <form [formGroup]="guestForm" class="step-form">
          <div class="form-section">
            <h3 class="section-title">
              <mat-icon>person</mat-icon>
              Datos del Huésped Principal
            </h3>

            <div class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Nombre</mat-label>
                <input matInput formControlName="firstName" placeholder="Ingrese su nombre">
                <mat-icon matSuffix>person</mat-icon>
                @if (guestForm.get('firstName')?.invalid && guestForm.get('firstName')?.touched) {
                  <mat-error>
                    El nombre es requerido (mín. 2 caracteres)
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Apellido</mat-label>
                <input matInput formControlName="lastName" placeholder="Ingrese su apellido">
                <mat-icon matSuffix>person_outline</mat-icon>
                @if (guestForm.get('lastName')?.invalid && guestForm.get('lastName')?.touched) {
                  <mat-error>
                    El apellido es requerido (mín. 2 caracteres)
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Teléfono</mat-label>
                <input matInput formControlName="phone" placeholder="+57 300 123 4567">
                <mat-icon matSuffix>phone</mat-icon>
                @if (guestForm.get('phone')?.invalid && guestForm.get('phone')?.touched) {
                  <mat-error>
                    Teléfono inválido o requerido
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Correo Electrónico</mat-label>
                <input matInput formControlName="email" type="email" placeholder="ejemplo@correo.com">
                <mat-icon matSuffix>email</mat-icon>
                @if (guestForm.get('email')?.invalid && guestForm.get('email')?.touched) {
                  <mat-error>
                    Email inválido o requerido
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Solicitudes Especiales (Opcional)</mat-label>
                <textarea matInput formControlName="requests" rows="3" maxlength="500"
                  placeholder="Ej: Cama extra, accesibilidad, alergias..."></textarea>
                <mat-icon matSuffix>note_add</mat-icon>
              </mat-form-field>
            </div>
          </div>

          <div class="step-actions">
            <button mat-raised-button color="primary" matStepperNext [disabled]="!guestForm.valid">
              Continuar
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Paso Confirmación -->
      <mat-step label="Confirmación">
        @defer (on viewport) {
          <div class="confirmation-step">
            <div class="confirmation-summary">
              <h3 class="section-title">
                <mat-icon>assignment_turned_in</mat-icon>
                Confirmar Reserva
              </h3>
      
              <div class="final-summary">
                <div class="guest-info">
                  <h4>Información del Huésped</h4>
                  <p><strong>Nombre:</strong> {{ guestForm.get('firstName')?.value }} {{ guestForm.get('lastName')?.value }}</p>
                  <p><strong>Teléfono:</strong> {{ guestForm.get('phone')?.value }}</p>
                  <p><strong>Email:</strong> {{ guestForm.get('email')?.value }}</p>
                  @if (guestForm.get('requests')?.value) {
                    <p><strong>Solicitudes:</strong> {{ guestForm.get('requests')?.value }}</p>
                  }
                </div>
      
                <div class="booking-info">
                  <h4>Detalles de la Reserva</h4>
                  <p><strong>Hotel:</strong> {{ selectedHotel()?.name }}</p>
                  <p><strong>Habitación:</strong> {{ selectedRoom()?.roomType }}</p>
                  <p><strong>Fechas:</strong> {{ formatDateRange() }}</p>
                  <p><strong>Huéspedes:</strong> {{ bookingForm.get('numberOfGuests')?.value }}</p>
                </div>
              </div>
      
              <div class="terms-section">
                <form [formGroup]="mainForm">
                  <mat-checkbox formControlName="acceptTerms" color="primary">
                    Acepto los <a href="/terminos" target="_blank">términos y condiciones</a>
                  </mat-checkbox>
                </form>
              </div>
            </div>
      
            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                Anterior
              </button>
              <button mat-raised-button color="primary" (click)="submitBooking()" [disabled]="!canSubmit() || isSubmitting()">
                @if (!isSubmitting()) {
                  <mat-icon>done</mat-icon>
                  <span>Confirmar Reserva</span>
                }
                @if (isSubmitting()) {
                  <mat-spinner diameter="20"></mat-spinner>
                }
              </button>
            </div>
          </div>
        } @placeholder {
          <p>preparando resumen de confirmación...</p>
        } @loading {
          <p>cargando resumen...</p>
        } @error {
          <p>no se pudo cargar la confirmación.</p>
        }
      </mat-step>

    </mat-horizontal-stepper>
  </div>

  <!-- Dialog de éxito -->
  @if (showSuccessDialog()) {
    <div class="success-overlay" (click)="closeSuccessDialog()">
      <div class="success-dialog" (click)="$event.stopPropagation()">
        <div class="success-content">
          <mat-icon class="success-icon">check_circle</mat-icon>
          <h2>¡Reserva Confirmada!</h2>
          <p>Su reserva ha sido procesada exitosamente.</p>
          <div class="success-actions">
            <button mat-raised-button color="primary" (click)="goToMyBookings()">Ver Mis Reservas</button>
            <button mat-button (click)="goToHome()">Volver al Inicio</button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
